#!/bin/bash

if test `find ${WOFFU_SIGNS_FILE} -mmin +30`; then
  rm $WOFFU_SIGNS_FILE
fi

if test `find ${WOFFU_PRESENCE_FILE} -mmin +30`; then
  rm $WOFFU_PRESENCE_FILE
fi

if [ ! -f $WOFFU_SIGNS_FILE ]; then
  curl -s "https://liferay.woffu.com/api/signs/slots" \
    -H "Content-Type: application/json;charset=UTF-8" \
    -H "Authorization: Bearer ${WOFFU_TOKEN}" > $WOFFU_SIGNS_FILE
fi

if [ ! -f $WOFFU_PRESENCE_FILE ]; then
  curl -s "https://liferay.woffu.com/api/users/${WOFFU_USER_ID}/diaries/presence/summary?calculateYearHours=false" \
    -H "Content-Type: application/json;charset=UTF-8" \
    -H "Authorization: Bearer ${WOFFU_TOKEN}" > $WOFFU_PRESENCE_FILE
fi

signs=$(cat $WOFFU_SIGNS_FILE | jq -c ".[]")
isSignIn="🏖️"
workSeconds=0
lastIn=0
lastOut=0

while read entry; do
  if [ -z "$entry" ]; then
    continue
  fi

  in=$(echo $entry | jq ".In")
  out=$(echo $entry | jq ".Out")

  if [ "$in" != "null" ]; then
    lastIn=$(date -d $(echo $in | jq -r ".ShortTrueTime") +%s)
    isSignIn="💪"
  fi

  if [ "$out" != "null" ]; then
    lastOut=$(date -d $(echo $out | jq -r ".ShortTrueTime") +%s)
    isSignIn="🏖️"
  fi

  if [ $lastOut -ge $lastIn ]; then
    workSeconds=$(($workSeconds + ($lastOut - $lastIn)))
  fi
done <<< "$(echo -e "$signs")"

if [ "$isSignIn" == "💪" ];  then
  now=$(date +%s)
  workSeconds=$(($workSeconds + ($now - $lastIn)))
fi

lastHoursWorked=$(cat /tmp/woffu-presence | jq -c ".[0].HoursWorked")
lastSecondsWorked=$(echo "${lastHoursWorked}*3600" | bc -l)
totalHoursToWork=$(cat /tmp/woffu-presence | jq -c ".[0].HoursToWork")
totalSecondsToWork=$(echo "${totalHoursToWork}*3600" | bc -l)
pendingSeconds=$(printf %.0f $(echo "${totalSecondsToWork}-${lastSecondsWorked}-${workSeconds}" | bc -l))
pendingHours=$(printf %f $(echo "scale=10; ${pendingSeconds#-}/3600" | bc -l) | cut -f1 -d'.')
pendingMinutes=$(printf %.0f $(echo "($(printf %0.2f $(echo "${pendingSeconds#-}/3600" | bc -l))-${pendingHours})*60" | bc -l))

if [ 0 -ge $pendingSeconds ]; then
  pendingTime="+$(printf %02d:%02d ${pendingHours} ${pendingMinutes})"
else
  pendingTime="-$(printf %02d:%02d ${pendingHours} ${pendingMinutes})"
fi

echo "$isSignIn $(date -d@${workSeconds} -u +%H:%M) / ${pendingTime}"
