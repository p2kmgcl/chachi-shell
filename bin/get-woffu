#!/bin/bash

function woffu_load {
  curl -s 'https://liferay.woffu.com/api/signs/slots' \
    -H 'Content-Type: application/json;charset=UTF-8' \
    -H "Authorization: Bearer ${WOFFU_TOKEN}" > $WOFFU_SIGNS_FILE
}

if [ ! -f $WOFFU_SIGNS_FILE ]; then
  woffu_load
fi

now=$(date +%s)
lastLoad=$(date -r $WOFFU_SIGNS_FILE +%s)
lastLoadDelta=$(($now - $lastLoad))
lastLoadMaxDelta=600 # seconds

if [ $lastLoadDelta -ge $lastLoadMaxDelta ]; then
  woffu_load
fi

signs=$(cat $WOFFU_SIGNS_FILE | jq -c ".[]")
isSignIn="üèñÔ∏è"
workTime=0
lastIn=0
lastOut=0

while read entry; do
  if [ -z "$entry" ]; then
    continue
  fi

  in=$(echo $entry | jq ".In")
  out=$(echo $entry | jq ".Out")

  if [ "$in" != "null" ]; then
    lastIn=$(date -d $(echo $in | jq -r ".ShortTrueTime") +%s)
    isSignIn="üí™"
  fi

  if [ "$out" != "null" ]; then
    lastOut=$(date -d $(echo $out | jq -r ".ShortTrueTime") +%s)
    isSignIn="üèñÔ∏è"
  fi

  if [ $lastOut -ge $lastIn ]; then
    workTime=$(($workTime + ($lastOut - $lastIn)))
  fi
done <<< "$(echo -e "$signs")"

if [ "$isSignIn" == "üí™" ];  then
  now=$(date +%s)
  workTime=$(($workTime + ($now - $lastIn)))
fi

echo "$isSignIn $(date -d@${workTime} -u +%H:%M)"
