#!/bin/bash

CMD_PREFIX=~/Projects/chachi-shell/bin/get
PIPE_PREFIX=/tmp/bar-status

COMMANDS="-2-music
-2-woffu
-1800-weather
-5-cpu
ğŸ’¡-5-brightness
ğŸ”‹-60-battery
ğŸ”‰-5-volume
ğŸ—“ï¸-1-time"

update_output() {
  all_output=""

  while IFS= read -r line; do
    IFS=- read icon delay name <<< "$line"

    touch "${PIPE_PREFIX}-${name}"
    touch "${PIPE_PREFIX}-${name}.previous"
    command_output=$(<"${PIPE_PREFIX}-${name}")
    previous_output=$(<"${PIPE_PREFIX}-${name}.previous")

    if [ ! -z "$command_output" ]; then
      all_output="${all_output} ${icon} ${command_output} "
    else
      if [ ! -z "$previous_output" ]; then
        all_output="${all_output} ${icon} ${previous_output} "
      fi
    fi
  done <<< "$COMMANDS"

  echo $all_output
}

run_daemon() {
  while true; do
    touch "${PIPE_PREFIX}-${2}"
    cp "${PIPE_PREFIX}-${2}" "${PIPE_PREFIX}-${2}.previous"
    ${CMD_PREFIX}-${2} > "${PIPE_PREFIX}-${2}"
    update_output
    sleep $1
  done
}

while IFS= read -r line; do
  IFS=- read icon delay name <<< "$line"
  run_daemon $delay $name &
done <<< "$COMMANDS"

wait
